
@{
    Layout = "~/Views/Shared/_LayoutAgentV2.cshtml";

    var storeList = (ViewBag.User as UserInfo).StoreList.ToDictionary(c => c.StoreId, c => c.StoreName);
    var productBase = (ViewBag.ProductBase as Dictionary<int, ProductBase>) ?? new Dictionary<int, ProductBase>();
    var porductList = (ViewBag.PorductList as Dictionary<int, Product>) ?? new Dictionary<int, Product>();
}

@using QingFeng.Common
@using QingFeng.Common.Extensions
@using QingFeng.Models
@model QingFeng.Common.ApiCore.Result.ApiPageList<OrderMaster>


<style type="text/css">
    #order-table-list thead tr {
        background: none;
    }

    th {
        text-align: center;
    }

    #order-table-list td {
        vertical-align: middle;
    }
</style>

<style>
    .table-responsive table thead tr th {
        text-align: center;
    }

    .table-responsive table tfoot td a.active {
        background-color: #337ab7;
        color: #fff;
    }
</style>
<div class="page-header">
    <h1 class="form-inline">
        @ViewBag.title<small>
            <a class="btn btn-info btn-sm pull-right load-view" href="/order/add" data-url="/order/add"><i class="icon icon-plus"></i> 添加订单</a>
            &nbsp;<i class="icon icon-search"></i>筛选:
            <div class="form-group">
                <select name="storeId" id="storeId" class="form-control input-sm">
                    <option value="0">店铺</option>
                    @foreach (var item in storeList)
                    {
                        <option @(ViewBag.storeId == item.Key ? "selected" : string.Empty ) value="@item.Key">@item.Value</option>
                    }
                </select>
            </div>
            <div class="form-group">
                从&nbsp;<input type="text" class="form-control input-sm" placeholder="请选择开始时间" value="@ViewBag.beginDateStr" readonly="" style="width:100px;" name="start_time" id="start_time">
                到&nbsp;<input type="text" class="form-control input-sm" placeholder="请选择结束时间" value="@ViewBag.endDateStr" readonly="" name="end_time" id="end_time">
            </div>
            <div class="form-group">
                <input type="text" class="form-control input-sm" maxlength="60" placeholder="订单号,流水号,收货人或电话" style="width:160px;" value="@ViewBag.keyWords" id="order_keyword" name="order_keyword">
                <button id="order-search" class="btn btn-primary btn-sm" type="button"><i class="icon icon-search"></i>搜索</button>
            </div>
        </small>
    </h1>
</div>
<div class="table-responsive">
    <table class="table table-striped table-bordered table-hover" id="order-table-list">
        <thead>
        <tr>
            <th rowspan="2">订单流水号</th>
            <th rowspan="2">日期</th>
            <th rowspan="2">店铺</th>
            <th rowspan="2">订单号</th>
            <th rowspan="2">收货人</th>
            <th rowspan="2">电话</th>
            <th colspan="5" style="border-bottom-width: 1px;">订单商品</th>
            <th rowspan="2" width="75" class="last">订单状态</th>
            <th rowspan="2" class="last">操作</th>
        </tr>
        <tr>
            <th width="60">品牌</th>
            <th width="110">商品货号</th>
            <th width="140">商品颜色</th>
            <th width="50">尺码</th>
            <th>状态</th>
        </tr>
        </thead>
        <tbody>
        @foreach (var item in Model.PageList)
        {
            for (var i = 0; i < item.OrderDetailCount; i++)
            {
                var detail = item.OrderDetails.ToList()[i];
                <tr align="center">
                    @if (i == 0)
                    {
                        <td rowspan="@item.OrderDetailCount">@item.OrderId</td>
                        <td rowspan="@item.OrderDetailCount">@item.CreateDate.ToString("yy-MM-dd HH:mm")</td>
                        <td rowspan="@item.OrderDetailCount">@item.StoreName</td>
                        <td rowspan="@item.OrderDetailCount">@item.OrderNo</td>
                        <td rowspan="@item.OrderDetailCount">@item.ContactName</td>
                        <td rowspan="@item.OrderDetailCount">@item.ContactPhone</td>
                    }
                    <td>@productBase[detail.BaseId].BrandId.ToString()</td>
                    <td>@productBase[detail.BaseId].BaseNo</td>
                    <td>@porductList[detail.ProductId].ProductNo</td>
                    <td>@detail.SkuName</td>
                    <td><span style="@detail.OrderStatus.GetOrderStyle()">@detail.OrderStatus</span></td>
                    @if (i == 0)
                    {
                        <td rowspan="@item.OrderDetailCount"><span style="@item.OrderStatus.GetOrderStyle()">@item.OrderStatus</span></td>
                        <td rowspan="@item.OrderDetailCount">
                            <a href="http://www.tonyzu.com/order/detail?orderId=@item.OrderId" data-url="/agent/orderDetail?orderId=@item.OrderId" class="load-view">查看</a>
                            @if (item.OrderStatus == AgentEnums.MasterOrderStatus.待支付)
                            {
                                <a href="javascript:viod(0);" class="pay-modal">去支付</a>
                                <a href="http://www.tonyzu.com/order/cancelOrder?orderId=@item.OrderId" title="" class="red order-canceled" data-id="@item.OrderId" data-name="@item.OrderId" data-trigger="focus" data-placement="left" tabindex="0" role="button" data-title="取消订单" data-original-title="取消订单">取消</a>
                            }
                        </td>
                    }
                </tr>
            }
        }
        </tbody>
        @if (Model.PageCount > 1)
        {
            <tfoot>
            <tr align="center">
                <td colspan="11">
                    @(Html.Raw(Model.GetPagerHtml(string.Format("/order/agentOrderList?brandId={0}&storeId={1}&orderStatus={2}&beginDateStr={3}&endDateStr={4}&keyWords={5}&page={6}", ViewBag.brandId, ViewBag.storeId, ViewBag.orderStatus, ViewBag.beginDateStr, ViewBag.endDateStr, ViewBag.keyWords, "{0}"))))
                </td>
            </tr>
            </tfoot>
        }
    </table>
</div>

<div class="modal fade" id="pay-qrcode" tabindex="-1" role="dialog" aria-labelledby="etop-modal-label">
    <div class="modal-dialog" role="document">
        <div class="modal-content form-horizontal">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="关闭"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title" id="myModalLabel">支付订单:tonyzu@126.com</h4>
            </div>
            <div class="modal-body">
                <div style="width: 100%; text-align: center">
                    <img src="/Content/img/alipay.png"/>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<link rel="stylesheet" href="/content/agent/css/bootstrap-datetimepicker.min.css">
<script src="/content/agent/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
<script type="text/javascript">
    $.fn.datetimepicker.dates['zh-CN'] = {
        days: ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六", "星期日"],
        daysShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六", "周日"],
        daysMin: ["日", "一", "二", "三", "四", "五", "六", "日"],
        months: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
        monthsShort: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
        today: "今天",
        suffix: [],
        meridiem: ["上午", "下午"]
    };
    $(function () {
        $("#start_time").datetimepicker({ format: 'yyyy-mm-dd', language: 'zh-CN', 'endDate': '@DateTime.Now.ToString("yyyy-MM-dd")', minView: "month", autoclose: 1 }).on('changeDate', function (ev) {
            $('#end_time').datetimepicker('setStartDate', $('#start_time').val());
        });

        $("#end_time").datetimepicker({ format: 'yyyy-mm-dd', language: 'zh-CN', 'endDate': '@DateTime.Now.ToString("yyyy-MM-dd")', minView: "month", autoclose: 1 });
        $('#order-search').click(function () {
            var start_time = $('#start_time').val();
            var end_time = $('#end_time').val();
            var keyword = $('#order_keyword').val();

            var url = location.pathname;
            url += '?beginDateStr=' + start_time;
            url += '&endDateStr=' + end_time;
            url += '&keyWords=' + encodeURI(keyword);
            url += '&storeId=' + $('#storeId').val();

            location.href = url;
        });

        $("[data-toggle='tooltip']").tooltip({ html: true });

        $.etopConfirm({ selector: '.order-canceled,order-finished' });

        $('#choose_all').click(function () {
            if ($('#choose_all').is(':checked') == true) {
                $('.choose-item').prop('checked', true);
            } else {
                $('.choose-item').prop('checked', false);
            }
        });

        $('.load-view').click(function () {
            var url = $(this).data('url');
            url += url.indexOf("?") > -1 ? "&stype=1" : "?stype=1";
            $.getPageContent({ url: url });
            return false;
        });


        $("span[data-order-status]").each(function () {
            var status = parseInt($(this).attr("data-order-status"));
            var color = status === 5 || status === 7
                ? "#428bca"
                : status === 1
                ? "#ccc"
                : status === 2
                ? "red"
                : status === 6
                ? "#5bc0de"
                : "";
            $(this).css("color", color);
        });

        $("span[data-detail-order-status]").each(function () {
            var status = parseInt($(this).attr("data-order-status"));
            var color = status === 1
                ? "#ccc"
                : status === 2
                ? "#428bca"
                : status === 3
                ? "#ccc"
                : "";
            $(this).css("color", color);
        });

        $('.load-content,.pagination a').off('click').on('click', function (e) {
            var url = $(this).attr('href');
            if (e.ctrlKey) {
                if (e.button == 0) {
                    window.open(url);
                    return false;
                }

            }

            $.getPageContent({ url: url });
            return false;
        });

        $.showModal({
            'selector': '.order-address-update',
        });

        $.showModal({
            formId: 'address-form',
            beforeSubmit: function(formData, jqForm, options) {
                return true;
            },
            success: function(response, status) {
                if (response.data === 1) {
                    layer.msg("保存成功");
                    $('#etop-modal').modal('hide');
                    $.pageReload();
                } else {
                    layer.alert(response.message);
                }
                return false;
            },
            selector: '.set-despatched'
        });

        $.showModal({
            'selector': '.view-order-notes'
        });

        $(".pay-modal").click(function() {
            $('#pay-qrcode').modal('show');
        });
    });
</script>
