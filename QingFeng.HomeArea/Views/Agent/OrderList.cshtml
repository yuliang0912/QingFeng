
@{
    ViewBag.Title = "OrderList";
    Layout = "~/Views/Shared/_LayoutAgent.cshtml";

    var productBase = (ViewBag.ProductBase as Dictionary<int, ProductBase>) ?? new Dictionary<int, ProductBase>();
    var porductList = (ViewBag.PorductList as Dictionary<int, Product>) ?? new Dictionary<int, Product>();
}
@using QingFeng.Models
@model QingFeng.Common.ApiCore.Result.ApiPageList<OrderMaster>

<link rel="stylesheet" href="/content/agent/css/bootstrap-datetimepicker.min.css">
<style type="text/css">
    th, td {
        text-align: center !important;
        vertical-align: middle !important;
    }

    th {
        text-align: center;
    }

    .pagination {
        margin: 10px 0;
    }
</style>

<div class="header" style="margin-top:0px;">
    <h1 class="form-inline" style="margin-top:0px;">
        订单列表<small>
            <a class="btn btn-info btn-sm pull-right load-view" href="/agent/addOrder" data-url="/agent/addOrder"><i class="icon icon-plus"></i> 添加订单</a>
            &nbsp;<i class="icon icon-search"></i>筛选:
            <div class="form-group">
                从&nbsp;<input type="text" class="form-control input-sm" placeholder="请选择开始时间" value="" readonly="" style="width:100px;" name="start_time" id="start_time">
                到&nbsp;<input type="text" class="form-control input-sm" placeholder="请选择结束时间" value="" readonly="" name="end_time" id="end_time">
            </div>
            <div class="form-group">
                <input type="text" class="form-control input-sm" maxlength="60" placeholder="订单号,流水号,收货人或电话" style="width:160px;" value="" id="order_keyword" name="order_keyword">
                <button id="order-search" class="btn btn-primary btn-sm" type="button"><i class="icon icon-search"></i>搜索</button>
            </div>
        </small>
    </h1>
</div>
<div class="table-responsive">
    <table class="table table-striped table-bordered table-hover" id="order-table-list">
        <thead>
            <tr>
                <th rowspan="2">订单流水号</th>
                <th rowspan="2">日期</th>
                <th rowspan="2">订单号</th>
                <th rowspan="2">收货人</th>
                <th rowspan="2">电话</th>
                <th colspan="4" style="border-bottom-width:1px;">订单商品</th>
                <th rowspan="2" width="80" class="last">订单状态</th>
                <th rowspan="2" class="last">操作</th>
            </tr>
            <tr>
                <th>商品货号</th>
                <th width="150">商品颜色</th>
                <th>尺码</th>
                <th width="60">状态</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in Model.PageList)
            {
                for (var i = 0; i < item.OrderDetailCount; i++)
                {
                    var detail = item.OrderDetails.ToList()[i];
                    <tr align="center">
                        @if (i == 0)
                        {
                            <td rowspan="@item.OrderDetailCount">@item.OrderId</td>
                            <td rowspan="@item.OrderDetailCount">@item.CreateDate.ToString()</td>
                                <td rowspan="@item.OrderDetailCount">@item.OrderNo</td>
                                <td rowspan="@item.OrderDetailCount">@item.ContactName</td>
                                <td rowspan="@item.OrderDetailCount">@item.ContactPhone</td>
                        }
                        <td>@productBase[detail.BaseId].BaseNo</td>
                        <td>@porductList[detail.ProductId].ProductNo</td>
                        <td>@detail.SkuName</td>
                        <td><span style="color: #5cb85c">@detail.OrderSatus</span></td>
                        @if (i == 0)
                        {
                            <td rowspan="@item.OrderDetailCount"><span style="color:#5bc0de"><span style="color:#0F0">正常进行</span></span></td>
                            <td rowspan="@item.OrderDetailCount" class="last">
                                <a href="/agent/orderDetail?orderId=@item.OrderId" data-url="/agent/orderDetail?orderId=@item.OrderId" class="load-view">查看</a>
                            </td>
                        }
                    </tr>
                }
            }
        </tbody>
        <tfoot>
            <tr align="center">
                <td colspan="17" style="text-align:left !important;"><input type="checkbox" name="choose_all" value="1" id="choose_all" style="margin-left:0.5%;"> <label for="choose_all"> 选中所有</label> <button type="submit" class="btn btn-sm btn-success" style="margin-left: 12px;">支付选中</button></td>
            </tr>
        </tfoot>
    </table>
    <script src="/content/agent/js/bootstrap-datetimepicker.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $.fn.datetimepicker.dates['zh-CN'] = {
            days: ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六", "星期日"],
            daysShort: ["周日", "周一", "周二", "周三", "周四", "周五", "周六", "周日"],
            daysMin: ["日", "一", "二", "三", "四", "五", "六", "日"],
            months: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
            monthsShort: ["一月", "二月", "三月", "四月", "五月", "六月", "七月", "八月", "九月", "十月", "十一月", "十二月"],
            today: "今天",
            suffix: [],
            meridiem: ["上午", "下午"]
        };
        $(function () {
            $("#start_time").datetimepicker({ format: 'yyyy-mm-dd', language: 'zh-CN', 'endDate': '@DateTime.Now.ToString("yyyy-MM-dd")', minView: "month", autoclose: 1 }).on('changeDate', function (ev) {
                $('#end_time').datetimepicker('setStartDate', $('#start_time').val());
            });

            $("#end_time").datetimepicker({ format: 'yyyy-mm-dd', language: 'zh-CN', 'endDate': '@DateTime.Now.ToString("yyyy-MM-dd")', minView: "month", autoclose: 1 });
            $('#order-search').click(function () {
                var shop_id = $('#shop_id').val() * 1;
                var start_time = $('#start_time').val();
                var end_time = $('#end_time').val();
                var brand_id = $('#brand_id').val() * 1;
                var supplier_id = $('#supplier_id').val() * 1;
                var keyword = $('#order_keyword').val();

                if (shop_id <= 0 && start_time == '' && end_time == '' && brand_id <= 0 && supplier_id <= 0 && keyword == '') {
                    alert('请选择或输入要筛选的条件！');
                    return false;
                }

                var url = 'http://agent.findshoes.cn/order/index';
                url += '?shop_id=' + shop_id;
                url += '&start_time=' + start_time;
                url += '&end_time=' + end_time;
                url += '&brand_id=' + brand_id;
                url += '&supplier_id=' + supplier_id;
                url += '&keyword=' + encodeURI(keyword);

                location.href = url;

            });

            $("[data-toggle='tooltip']").tooltip({ html: true });

            $.etopConfirm({ selector: '.order-canceled,order-finished' });

            $('#choose_all').click(function () {
                if ($('#choose_all').is(':checked') == true) {
                    $('.choose-item').prop('checked', true);
                } else {
                    $('.choose-item').prop('checked', false);
                }
            });

            $('#order-form').submit(function (e) {
                var l = $('.choose-item:checked').length;
                if (l == 0) {
                    alert('请选择需要支付的订单');
                    return false;
                } else {
                    return true;
                }
            });

            $('.load-view').click(function () {
                var url = $(this).data('url');
                url += url.indexOf("?") > -1 ? "&stype=1" : "?stype=1";
                $.getPageContent({ url: url });
                return false;
            });

            $('.pagination a').click(function () {
                var url = $(this).attr('href');
                $.getPageContent({ url: url });
                return false;
            });
        });
    </script>
</div>
